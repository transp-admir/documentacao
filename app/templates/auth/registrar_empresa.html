<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Nova Empresa - SGV</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome para ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Estilo customizado -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/login.css') }}">
</head>
<body>
    <div class="login-container">
        <div class="login-box">
            <div class="login-header">
                <h3>Finalize seu Cadastro</h3>
                <p>Preencha os dados abaixo para criar o acesso da sua empresa.</p>
            </div>

            {% include '_includes/flash_messages.html' %}

            <form method="POST" action="" novalidate>
                {{ form.hidden_tag() }}

                <fieldset class="mb-4">
                    <legend class="fieldset-legend"><i class="fas fa-building"></i> Dados da Empresa</legend>
                    
                    <div class="form-floating mb-3">
                        {{ form.cnpj(class_="form-control", placeholder="CNPJ") }}
                        {{ form.cnpj.label }}
                        <div class="form-text">Digite o CNPJ e pressione <strong>Enter</strong> ou <strong>Tab</strong> para consultar.</div>
                    </div>
                    
                    <div class="form-floating mb-3">
                        {{ form.razao_social(class_="form-control", placeholder="Razão Social") }}
                        {{ form.razao_social.label }}
                    </div>

                </fieldset>

                <fieldset>
                    <legend class="fieldset-legend"><i class="fas fa-user"></i> Dados do Novo Usuário</legend>
                    <div class="form-floating mb-3">
                        {{ form.nome_usuario(class_="form-control", placeholder="Seu Nome Completo") }}
                        {{ form.nome_usuario.label }}
                    </div>
                    <div class="form-floating mb-3">
                        {{ form.login(class_="form-control", placeholder="Seu E-mail (será seu login)") }}
                        {{ form.login.label }}
                    </div>
                    <div class="form-floating mb-3">
                        {{ form.password(class_="form-control", placeholder="Crie uma Senha") }}
                        {{ form.password.label }}
                    </div>
                    <div class="form-floating mb-3">
                        {{ form.password2(class_="form-control", placeholder="Confirme a Senha") }}
                        {{ form.password2.label }}
                    </div>
                </fieldset>

                <div class="d-grid mt-4">
                    {{ form.submit(class_="btn btn-primary btn-block") }}
                </div>
            </form>

            <div class="login-footer">
                <p>Já tem uma conta? <a href="{{ url_for('auth.login_page') }}">Faça login</a></p>
                <p class="text-muted">&copy; {{ ano }} SGV. Todos os direitos reservados.</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const cnpjField = document.getElementById('cnpj');
            const razaoSocialField = document.getElementById('razao_social');

            // Função centralizada para buscar o CNPJ
            const lookupCnpj = () => {
                const cnpjValue = cnpjField.value.replace(/\D/g, '');

                if (cnpjValue.length === 14) {
                    const url = `/consultar-cnpj/${cnpjValue}`;
                    fetch(url)
                        .then(response => response.json())
                        .then(data => {
                            if (data.exists && data.razao_social) {
                                // Empresa encontrada: preenche, bloqueia e avança
                                razaoSocialField.value = data.razao_social;
                                razaoSocialField.readOnly = true;
                                razaoSocialField.dispatchEvent(new Event('input', { bubbles: true })); // Força atualização do label
                                document.getElementById('nome_usuario').focus();
                            } else {
                                // Empresa não encontrada: limpa, libera e foca
                                razaoSocialField.value = '';
                                razaoSocialField.readOnly = false;
                                razaoSocialField.dispatchEvent(new Event('input', { bubbles: true })); // Força atualização do label
                                razaoSocialField.focus();
                            }
                        })
                        .catch(error => {
                            console.error('Erro ao consultar CNPJ:', error);
                            razaoSocialField.readOnly = false; // Libera em caso de erro
                        });
                }
            };

            if (cnpjField && razaoSocialField) {
                // Aciona a busca ao sair do campo (com Tab ou clique)
                cnpjField.addEventListener('blur', lookupCnpj);

                // Aciona a busca ao pressionar Enter
                cnpjField.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault(); // Impede o envio do formulário
                        lookupCnpj();
                    }
                });
            }
        });
    </script>

</body>
</html>